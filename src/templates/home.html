{% extends "./layout.html" %}
{% block title %}Taquilla - Home{% endblock %}

{% block body %}
<div class="container py-4">
  {# Mensajes flash (ej. venta registrada, errores, etc.) #}
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mb-3">
        {% for category, message in messages %}
          <div class="alert alert-{{ 'warning' if category == 'message' else category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  {# Encabezado #}
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h3 mb-1">Panel de taquilla</h1>
      <p class="mb-0 text-muted">
        Bienvenido, <strong>{{ current_user.nombre_completo }}</strong>
        <span class="text-secondary">({{ current_user.rol }})</span>
      </p>
    </div>
    <div class="text-end">
      <small class="text-muted d-block">
        Hoy: {{ fecha_hoy|default('Fecha del día') }}
      </small>

      <form method="POST" action="{{ url_for('logout') }}" class="mt-2">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button type="submit" class="btn btn-outline-danger btn-sm">
          Cerrar sesión
        </button>
      </form>
    </div>
  </div>

  {# KPIs del día #}
  <div class="row g-3 mb-4">
    <div class="col-md-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <h6 class="card-subtitle mb-2 text-muted">Boletos vendidos hoy</h6>
          <h3 class="card-title mb-0">
            {{ boletos_hoy|default(0) }}
          </h3>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <h6 class="card-subtitle mb-2 text-muted">Monto total del día</h6>
          <h3 class="card-title mb-0">
            ${{ monto_hoy|default("0.00") }} MXN
          </h3>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <h6 class="card-subtitle mb-2 text-muted">Viajes programados hoy</h6>
          <h3 class="card-title mb-0">
            {{ viajes_hoy_count|default(0) }}
          </h3>
        </div>
      </div>
    </div>
  </div>

  {# Acciones principales #}
  <div class="row g-3 mb-4">
    {% if current_user.rol == 'Admin' %}
    <div class="col-md-3">
      <div class="card border-0 shadow-sm h-100 bg-gradient" style="background: linear-gradient(135deg, #667eea 0%, #0B7ED9 100%);">
        <div class="card-body d-flex flex-column text-white">
          <h5 class="card-title">
            <i class="bi bi-speedometer2"></i> Panel Admin
          </h5>
          <p class="card-text flex-grow-1">
            Gestionar usuarios y configuraciones del sistema.
          </p>
          <a href="{{ url_for('admin') }}" class="btn btn-light mt-auto">
            Ir al panel de Administrador
          </a>
        </div>
      </div>
    </div>
    {% endif %}

    {% if current_user.rol == 'Chofer' %}
    <div class="col-md-4">
      <div class="card border-0 shadow-sm h-100 bg-gradient" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <div class="card-body d-flex flex-column text-white">
          <h5 class="card-title">
            <i class="bi bi-bus-front"></i> Panel del Chofer
          </h5>
          <p class="card-text flex-grow-1">
            Ver tus viajes programados, próximos destinos y historial.
          </p>
          <a href="{{ url_for('chofer') }}" class="btn btn-light mt-auto">
            Ir al panel
          </a>
        </div>
      </div>
    </div>
    {% endif %}
    
    <div class="col-md-{% if current_user.rol == 'Admin' %}3{% elif current_user.rol == 'Chofer' %}4{% else %}4{% endif %}">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body d-flex flex-column">
          <h5 class="card-title">Nueva venta</h5>
          <p class="card-text text-muted flex-grow-1">
            Registrar un nuevo boleto para un pasajero en un viaje programado.
          </p>
          <a href="#" class="btn btn-primary mt-auto">
            Ir a nueva venta
          </a>
        </div>
      </div>
    </div>

    <div class="col-md-{% if current_user.rol == 'Admin' %}3{% elif current_user.rol == 'Chofer' %}4{% else %}4{% endif %}">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body d-flex flex-column">
          <h5 class="card-title">Consultar disponibilidad</h5>
          <p class="card-text text-muted flex-grow-1">
            Buscar viajes por origen, destino y fecha, y revisar asientos disponibles.
          </p>
          <a href="#" class="btn btn-outline-primary mt-auto">
            Ver disponibilidad
          </a>
        </div>
      </div>
    </div>

    <div class="col-md-{% if current_user.rol == 'Admin' %}3{% elif current_user.rol == 'Chofer' %}4{% else %}4{% endif %}">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body d-flex flex-column">
          <h5 class="card-title">Ventas del día</h5>
          <p class="card-text text-muted flex-grow-1">
            Consultar las ventas realizadas hoy (por este usuario o por la taquilla).
          </p>
          <a href="#" class="btn btn-outline-secondary mt-auto">
            Ver ventas del día
          </a>
        </div>
      </div>
    </div>
  </div>

  {# Tabla de viajes programados para hoy #}
  <div class="card border-0 shadow-sm">
    <div class="card-header bg-white">
      <h5 class="mb-0">Viajes programados para hoy</h5>
      <small class="text-muted">
        Selecciona un viaje para iniciar una venta rápida.
      </small>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0 align-middle">
          <thead class="table-light">
          <tr>
            <th scope="col">Salida</th>
            <th scope="col">Llegada</th>
            <th scope="col">Origen</th>
            <th scope="col">Destino</th>
            <th scope="col">Ruta / Clase</th>
            <th scope="col">Chofer</th>
            <th scope="col">Autobús</th>
            <th scope="col" class="text-center">Asientos disp.</th>
            <th scope="col" class="text-end">Acción</th>
          </tr>
          </thead>
          <tbody>
  {% if viajes_hoy %}
    {% for v in viajes_hoy %}
      <tr>
        <td>{{ v.fecha_salida }}</td>
        <td>{{ v.fecha_llegada }}</td>
        <td>{{ v.origen_ciudad }} - {{ v.origen_terminal }}</td>
        <td>{{ v.destino_ciudad }} - {{ v.destino_terminal }}</td>
        <td>{{ v.ruta_nombre }} / {{ v.clase_nombre }}</td>
        <td>{{ v.chofer_nombre }}</td>
        <td>{{ v.autobus_identificador }}</td>
        <td class="text-center">{{ v.asientos_disponibles }}</td>
        <td class="text-end">
          {# En el futuro: llevar a nueva venta con este viaje #}
          {# <a href="{{ url_for('nueva_venta', id_viaje=v.id_viaje) }}" class="btn btn-sm btn-success">Vender</a> #}
        </td>
      </tr>
    {% endfor %}
  {% else %}
    <tr>
      <td colspan="9" class="text-center text-muted py-4">
        No hay viajes programados para hoy.
      </td>
    </tr>
  {% endif %}
</tbody>

        </table>
      </div>
    </div>
  </div>

</div>
{% endblock %}
