{% extends 'layout.html' %}

{% block title %}Panel de Administraci칩n - BusLink{% endblock %}

{% block customCSS %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
<style>
    .admin-header {
        background-color: #1A6098;
        color: white;
        padding: 2rem 0;
        margin-bottom: 2rem;
    }
    .stats-card {
        border-left: 4px solid #667eea;
        transition: transform 0.2s;
    }
    .stats-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: white;
    }
    .status-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }
    .action-btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }
    .modal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    .role-badge {
        font-size: 0.8rem;
    }
</style>
{% endblock %}

{% block body %}
<div class="admin-header">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="mb-0"><i class="bi bi-speedometer2"></i> Panel de Administraci칩n</h1>
                <p class="mb-0 mt-2">Gestiona usuarios y configuraciones del sistema</p>
            </div>
            <div class="col-md-4 text-md-end">
                <button class="btn btn-light btn-lg" data-bs-toggle="modal" data-bs-target="#createUserModal">
                    <i class="bi bi-person-plus"></i> Nuevo Usuario
                </button>
            </div>
        </div>
    </div>
</div>

<div class="container mb-5">
    <!-- Mensajes Flash -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    <i class="bi bi-{% if category == 'success' %}check-circle{% elif category == 'danger' %}exclamation-triangle{% else %}info-circle{% endif %}"></i>
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Estad칤sticas -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card stats-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted mb-0">Total Usuarios</p>
                            <h3 class="mb-0">{{ users|length }}</h3>
                        </div>
                        <div class="text-primary" style="font-size: 2rem;">
                            <i class="bi bi-people"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted mb-0">Activos</p>
                            <h3 class="mb-0 text-success">{{ users|selectattr('activo', 'equalto', 1)|list|length }}</h3>
                        </div>
                        <div class="text-success" style="font-size: 2rem;">
                            <i class="bi bi-check-circle"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted mb-0">Inactivos</p>
                            <h3 class="mb-0 text-danger">{{ users|selectattr('activo', 'equalto', 0)|list|length }}</h3>
                        </div>
                        <div class="text-danger" style="font-size: 2rem;">
                            <i class="bi bi-x-circle"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted mb-0">Administradores</p>
                            <h3 class="mb-0 text-warning">{{ users|selectattr('rol', 'equalto', 'Admin')|list|length }}</h3>
                        </div>
                        <div class="text-warning" style="font-size: 2rem;">
                            <i class="bi bi-shield-check"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de Usuarios -->
    <div class="card shadow-sm">
        <div class="card-header bg-white py-3">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h5 class="mb-0"><i class="bi bi-list-ul"></i> Lista de Usuarios</h5>
                </div>
                <div class="col-md-6">
                    <input type="text" class="form-control" id="searchInput" placeholder="游댌 Buscar usuarios...">
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0" id="usersTable">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>Usuario</th>
                            <th>Email</th>
                            <th>Rol</th>
                            <th>Estado</th>
                            <th class="text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for usr in users %}
                        <tr>
                            <td class="align-middle">{{ usr.id_usuario }}</td>
                            <td class="align-middle">
                                <div class="d-flex align-items-center">
                                    <div class="user-avatar bg-primary me-2">
                                        {{ usr.nombre_completo[0]|upper }}
                                    </div>
                                    <span class="fw-semibold">{{ usr.nombre_completo }}</span>
                                </div>
                            </td>
                            <td class="align-middle">{{ usr.email }}</td>
                            <td class="align-middle">
                                <span class="badge role-badge 
                                    {% if usr.rol == 'Admin' %}bg-danger
                                    {% elif usr.rol == 'Empleado' %}bg-primary
                                    {% elif usr.rol == 'Chofer' %}bg-warning text-dark
                                    {% elif usr.rol == 'Mecanico' %}bg-info
                                    {% else %}bg-secondary{% endif %}">
                                    {{ usr.rol }}
                                </span>
                            </td>
                            <td class="align-middle">
                                {% if usr.activo == 1 %}
                                    <span class="badge bg-success status-badge">
                                        <i class="bi bi-check-circle"></i> Activo
                                    </span>
                                {% else %}
                                    <span class="badge bg-danger status-badge">
                                        <i class="bi bi-x-circle"></i> Inactivo
                                    </span>
                                {% endif %}
                            </td>
                            <td class="align-middle text-center">
                                <div class="btn-group" role="group">
                                    <button class="btn btn-sm btn-outline-primary action-btn" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#editUserModal{{ usr.id_usuario }}"
                                            title="Editar">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-warning action-btn" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#passwordModal{{ usr.id_usuario }}"
                                            title="Cambiar Contrase침a">
                                        <i class="bi bi-key"></i>
                                    </button>
                                    <form method="POST" action="{{ url_for('toggle_user', id_usuario=usr.id_usuario) }}" class="d-inline">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <button type="submit" 
                                                class="btn btn-sm action-btn {% if usr.activo %}btn-outline-danger{% else %}btn-outline-success{% endif %}"
                                                onclick="return confirm('쮺onfirmar cambio de estado?')"
                                                title="{% if usr.activo %}Desactivar{% else %}Activar{% endif %}">
                                            <i class="bi bi-{% if usr.activo %}x-circle{% else %}check-circle{% endif %}"></i>
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>

                        <!-- Modal Editar Usuario -->
                        <div class="modal fade" id="editUserModal{{ usr.id_usuario }}" tabindex="-1">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">
                                            <i class="bi bi-pencil-square"></i> Editar Usuario
                                        </h5>
                                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                    </div>
                                    <form method="POST" action="{{ url_for('update_user', id_usuario=usr.id_usuario) }}">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <div class="modal-body">
                                            <div class="mb-3">
                                                <label class="form-label">Nombre Completo</label>
                                                <input type="text" class="form-control" name="nombre_completo" 
                                                       value="{{ usr.nombre_completo }}" required>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Email</label>
                                                <input type="email" class="form-control" name="email" 
                                                       value="{{ usr.email }}" required>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Rol</label>
                                                <select class="form-select" name="rol" required>
                                                    <option value="Admin" {% if usr.rol == 'Admin' %}selected{% endif %}>Admin</option>
                                                    <option value="Empleado" {% if usr.rol == 'Empleado' %}selected{% endif %}>Empleado</option>
                                                    <option value="Chofer" {% if usr.rol == 'Chofer' %}selected{% endif %}>Chofer</option>
                                                    <option value="Mecanico" {% if usr.rol == 'Mecanico' %}selected{% endif %}>Mec치nico</option>
                                                    <option value="Cliente" {% if usr.rol == 'Cliente' %}selected{% endif %}>Cliente</option>
                                                </select>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Estado</label>
                                                <select class="form-select" name="activo" required>
                                                    <option value="1" {% if usr.activo == 1 %}selected{% endif %}>Activo</option>
                                                    <option value="0" {% if usr.activo == 0 %}selected{% endif %}>Inactivo</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                            <button type="submit" class="btn btn-primary">
                                                <i class="bi bi-save"></i> Guardar Cambios
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- Modal Cambiar Contrase침a -->
                        <div class="modal fade" id="passwordModal{{ usr.id_usuario }}" tabindex="-1">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">
                                            <i class="bi bi-key"></i> Cambiar Contrase침a
                                        </h5>
                                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                    </div>
                                    <form method="POST" action="{{ url_for('change_password', id_usuario=usr.id_usuario) }}">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <div class="modal-body">
                                            <div class="alert alert-info">
                                                <i class="bi bi-info-circle"></i> Cambiar치s la contrase침a de: <strong>{{ usr.nombre_completo }}</strong>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Nueva Contrase침a</label>
                                                <input type="password" class="form-control" name="new_password" 
                                                       minlength="6" required placeholder="M칤nimo 6 caracteres">
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                            <button type="submit" class="btn btn-warning">
                                                <i class="bi bi-key"></i> Cambiar Contrase침a
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal Crear Usuario (Usuario + Empleado + Chofer) -->
<div class="modal fade" id="createUserModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-person-plus"></i> Registrar Nuevo Usuario
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('create_user') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <!-- Datos de la cuenta de acceso (tabla Usuario) -->
                    <h6 class="mb-3"><i class="bi bi-person-circle"></i> Datos de acceso</h6>
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Nombre Completo</label>
                            <input type="text" class="form-control" name="nombre_completo"
                                   placeholder="Ej: Juan P칠rez Garc칤a" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Email corporativo</label>
                            <input type="email" class="form-control" name="email"
                                   placeholder="usuario@buslink.com" required>
                            <small class="text-muted">Debe terminar en @buslink.com</small>
                        </div>
                    </div>
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Contrase침a</label>
                            <input type="password" class="form-control" name="password"
                                   minlength="6" placeholder="M칤nimo 6 caracteres" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Rol de sistema</label>
                            <select class="form-select" name="rol" id="rolSelect" required>
                                <option value="">Seleccione un rol...</option>
                                <option value="Admin">Administrador</option>
                                <option value="Empleado" selected>Empleado (Taquilla)</option>
                                <option value="Chofer">Chofer</option>
                                <!-- Se mantienen otros roles por si los necesitas m치s adelante -->
                                <option value="Mecanico">Mec치nico</option>
                                <option value="Cliente">Cliente</option>
                            </select>
                        </div>
                    </div>

                    <hr>

                    <!-- Datos de Empleado (tabla Empleado) -->
                    <h6 class="mb-3"><i class="bi bi-briefcase"></i> Datos de empleado</h6>
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Tel칠fono</label>
                            <input type="tel" class="form-control" name="telefono_empleado"
                                   placeholder="Ej: 8123456789">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Estado laboral</label>
                            <input type="text" class="form-control" value="Activo" disabled>
                            <small class="text-muted">El usuario se crear치 como activo por defecto.</small>
                        </div>
                    </div>

                    <!-- Datos espec칤ficos de Chofer (tabla Chofer) -->
                    <div id="choferFields" style="display:none;">
                        <hr>
                        <h6 class="mb-3"><i class="bi bi-bus-front"></i> Datos espec칤ficos de chofer</h6>
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label class="form-label">RFC</label>
                                <input type="text" class="form-control" name="rfc" maxlength="13" placeholder="RFC del chofer">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">CURP</label>
                                <input type="text" class="form-control" name="curp" maxlength="18" placeholder="CURP del chofer">
                            </div>
                        </div>
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label class="form-label">NSS</label>
                                <input type="text" class="form-control" name="nss" maxlength="15" placeholder="N칰mero de Seguro Social">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Direcci칩n</label>
                                <input type="text" class="form-control" name="direccion" placeholder="Direcci칩n completa">
                            </div>
                        </div>
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Fecha de ingreso</label>
                                <input type="date" class="form-control" name="fecha_ingreso">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Licencia</label>
                                <input type="text" class="form-control" name="licencia" placeholder="N칰mero de licencia" >
                            </div>
                        </div>
                        <div class="row g-3 mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Tipo de licencia</label>
                                <input type="text" class="form-control" name="licencia_tipo" placeholder="Ej: A, B, C">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Fecha de expiraci칩n</label>
                                <input type="date" class="form-control" name="licencia_expira">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">A침os de experiencia</label>
                                <input type="number" class="form-control" name="anios_experiencia" min="0" value="0">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Notas</label>
                            <textarea class="form-control" name="notas" rows="2" placeholder="Informaci칩n adicional sobre el chofer"></textarea>
                        </div>
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i>
                            Estos datos se guardar치n en la tabla <strong>Chofer</strong>, vinculados al empleado creado.
                        </div>
                    </div>

                    <div class="alert alert-warning mt-3">
                        <i class="bi bi-exclamation-triangle"></i> <strong>Nota:</strong> El usuario se crear치 con estado <strong>Activo</strong> por defecto
                        y se registrar치 como <strong>Empleado</strong>. Si el rol es <strong>Chofer</strong>, tambi칠n se crear치 el registro completo en la tabla <strong>Chofer</strong>.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-person-plus"></i> Crear Usuario
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// B칰squeda en tiempo real en la tabla
document.getElementById('searchInput').addEventListener('keyup', function() {
    const searchValue = this.value.toLowerCase();
    const tableRows = document.querySelectorAll('#usersTable tbody tr');

    tableRows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchValue) ? '' : 'none';
    });
});

// Mostrar / ocultar campos de chofer seg칰n el rol seleccionado
const rolSelect = document.getElementById('rolSelect');
const choferFields = document.getElementById('choferFields');

if (rolSelect && choferFields) {
    function toggleChoferFields() {
        if (rolSelect.value === 'Chofer') {
            choferFields.style.display = '';
        } else {
            choferFields.style.display = 'none';
        }
    }

    rolSelect.addEventListener('change', toggleChoferFields);
    // Inicializar al abrir la p치gina
    toggleChoferFields();
}
</script>
{% endblock %}
